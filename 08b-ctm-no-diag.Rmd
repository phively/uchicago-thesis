---
title: "Correlated topic model with diagonal covariance"
output: html_notebook
---

# Goal

  * Use the `stm` package to fit CTMs with diagonal $\Sigma$
  * Have a baseline for comparing structural topic models

# Libraries used

```{r, warning=F, message=F, error=F, comment=F}
library(tidyverse)
library(slam)
library(stm)
library(foreach)
library(doParallel)
```

Set up parallel runs

```{r}
registerDoParallel(5)
getDoParWorkers()
```

# Load the final data

See [06-dataset-comparison.Rmd](https://github.com/phively/uchicago-thesis/blob/master/06-dataset-comparison.Rmd) for details on how the sparse matrix was generated.

```{r, message=F}
# Load sparse matrix with no tex
load(file = "data/sparse_matrix_no_tex.zip")
sparse <- readCorpus(sparse, type = "slam")
```

# CTM method without correlations

Topics $K \in \left\{ 5, 10, \dots, 50 \right\}$

```{r}
# 5
gc()
nc_ctm05 <- searchK(sparse$documents, sparse$vocab, K = 5, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm05, file = "results/nc_ctm05.zip", compress = "xz", compression_level = 1)

# 10
gc()
nc_ctm10 <- searchK(sparse$documents, sparse$vocab, K = 10, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm10, file = "results/nc_ctm10.zip", compress = "xz", compression_level = 1)

# 15
gc()
nc_ctm15 <- searchK(sparse$documents, sparse$vocab, K = 15, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm15, file = "results/nc_ctm15.zip", compress = "xz", compression_level = 1)

# 20
gc()
nc_ctm20 <- searchK(sparse$documents, sparse$vocab, K = 20, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm20, file = "results/nc_ctm20.zip", compress = "xz", compression_level = 1)

# 25
gc()
nc_ctm25 <- searchK(sparse$documents, sparse$vocab, K = 25, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm25, file = "results/nc_ctm25.zip", compress = "xz", compression_level = 1)

# 30
gc()
nc_ctm30 <- searchK(sparse$documents, sparse$vocab, K = 30, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm30, file = "results/nc_ctm30.zip", compress = "xz", compression_level = 1)

# 35
gc()
nc_ctm35 <- searchK(sparse$documents, sparse$vocab, K = 35, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm35, file = "results/nc_ctm35.zip", compress = "xz", compression_level = 1)

# 40
gc()
nc_ctm40 <- searchK(sparse$documents, sparse$vocab, K = 40, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm40, file = "results/nc_ctm40.zip", compress = "xz", compression_level = 1)

# 45
gc()
nc_ctm45 <- searchK(sparse$documents, sparse$vocab, K = 45, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm45, file = "results/nc_ctm45.zip", compress = "xz", compression_level = 1)

# 50
gc()
nc_ctm50 <- searchK(sparse$documents, sparse$vocab, K = 50, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm50, file = "results/nc_ctm50.zip", compress = "xz", compression_level = 1)
```

```{r}
xval <- bind_rows(nc_ctm05$results, nc_ctm10$results, nc_ctm15$results, nc_ctm20$results, nc_ctm25$results,
  nc_ctm30$results, nc_ctm35$results, nc_ctm40$results, nc_ctm45$results, nc_ctm50$results)
write.csv(xval, file = "results/nc_ctm_xval.csv", row.names = FALSE)
```

```{r}
xval %>% ggplot(aes(x = K, y = heldout)) + geom_point()
```

There's clearly room for improvement.

# CTM method, diagonal $\Sigma$, 60 through 150

```{r}
# 60
gc()
nc_ctm60 <- searchK(sparse$documents, sparse$vocab, K = 60, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm60, file = "results/nc_ctm60.zip", compress = "xz", compression_level = 1)

# 70
gc()
nc_ctm70 <- searchK(sparse$documents, sparse$vocab, K = 70, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm70, file = "results/nc_ctm70.zip", compress = "xz", compression_level = 1)

# 80
gc()
nc_ctm80 <- searchK(sparse$documents, sparse$vocab, K = 80, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm80, file = "results/nc_ctm80.zip", compress = "xz", compression_level = 1)

# 90
gc()
nc_ctm90 <- searchK(sparse$documents, sparse$vocab, K = 90, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm90, file = "results/nc_ctm90.zip", compress = "xz", compression_level = 1)

# 100
gc()
nc_ctm100 <- searchK(sparse$documents, sparse$vocab, K = 100, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm100, file = "results/nc_ctm100.zip", compress = "xz", compression_level = 1)

# 110
gc()
nc_ctm110 <- searchK(sparse$documents, sparse$vocab, K = 110, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm110, file = "results/nc_ctm110.zip", compress = "xz", compression_level = 1)

# 120
gc()
nc_ctm120 <- searchK(sparse$documents, sparse$vocab, K = 120, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm120, file = "results/nc_ctm120.zip", compress = "xz", compression_level = 1)

# 130
gc()
nc_ctm130 <- searchK(sparse$documents, sparse$vocab, K = 130, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm130, file = "results/nc_ctm130.zip", compress = "xz", compression_level = 1)

# 140
gc()
nc_ctm140 <- searchK(sparse$documents, sparse$vocab, K = 140, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm140, file = "results/nc_ctm140.zip", compress = "xz", compression_level = 1)

# 150
gc()
nc_ctm150 <- searchK(sparse$documents, sparse$vocab, K = 150, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm150, file = "results/nc_ctm150.zip", compress = "xz", compression_level = 1)
```

# Update cross-validation data frame

```{r}
xval <- bind_rows(xval,
  nc_ctm60$results, nc_ctm70$results, nc_ctm80$results, nc_ctm90$results, nc_ctm100$results,
  nc_ctm110$results, nc_ctm120$results, nc_ctm130$results, nc_ctm140$results, nc_ctm150$results)
write.csv(xval, file = "results/nc_ctm_xval.csv", row.names = FALSE)
```

```{r}
xval %>% ggplot(aes(x = K, y = heldout)) + geom_point()
```

# New strategy -- true hold-out cross-validation

## Holdout set

```{r}
# Create holdout sets
holdout1 <- make.heldout(documents = sparse$documents, vocab = sparse$vocab,
  N = 18467, proportion = 1, seed = 70886)
holdout2 <- make.heldout(documents = sparse$documents, vocab = sparse$vocab,
  N = 18467, proportion = 1, seed = 57199)
holdout3 <- make.heldout(documents = sparse$documents, vocab = sparse$vocab,
  N = 18467, proportion = 1, seed = 68467)
```

## Test group, K = 5

```{r}
# Test group

# 5
gc()
nc_ctm05 <- stm(holdout$documents, holdout$vocab, K = 5, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(holdout$vocab)), sigma.prior = 1)
save(nc_ctm05, file = "results/nc_ctm05.zip", compress = "xz", compression_level = 1)
```

## 10 through 50

### A

```{r}
# Parallel run
gc()
nc_10_50a <- foreach(k = c(10, 20, 30, 40, 50)) %dopar% {
  stm(holdout1$documents, holdout1$vocab, K = k, init.type = "Spectral", ngroups = 5,
    control = list(maxV = length(holdout1$vocab)), sigma.prior = 1)
}
save(nc_10_50a, file = "results/nc_10_50a.zip", compress = "xz", compression_level = 1)
```

### B

```{r}
# Parallel run
gc()
nc_10_50b <- foreach(k = c(10, 20, 30, 40, 50)) %dopar% {
  stm(holdout2$documents, holdout2$vocab, K = k, init.type = "Spectral", ngroups = 5,
    control = list(maxV = length(holdout2$vocab)), sigma.prior = 1)
}
save(nc_10_50b, file = "results/nc_10_50b.zip", compress = "xz", compression_level = 1)
```

### C

```{r}
# Parallel run
gc()
nc_10_50c <- foreach(k = c(10, 20, 30, 40, 50)) %dopar% {
  stm(holdout3$documents, holdout3$vocab, K = k, init.type = "Spectral", ngroups = 5,
    control = list(maxV = length(holdout3$vocab)), sigma.prior = 1)
}
save(nc_10_50c, file = "results/nc_10_50c.zip", compress = "xz", compression_level = 1)
```

# Evaluate holdout samples

```{r}
h5 <- eval.heldout(nc_ctm05, missing = holdout$missing)
h10_50a <- lapply(nc_10_50a, eval.heldout, missing = holdout1$missing)
h10_50b <- lapply(nc_10_50b, eval.heldout, missing = holdout2$missing)
h10_50c <- lapply(nc_10_50c, eval.heldout, missing = holdout3$missing)
```

```{r}
a <- matrix(0, nrow = 5, ncol = 3)
for (i in 1:5) {
  a[i, 1] <- h10_50a[[i]]$expected
  a[i, 2] <- h10_50b[[i]]$expected
  a[i, 3] <- h10_50c[[i]]$expected
}
```

```{r}
plot(as.vector(a) ~ rep(1:5, times = 3))
lines(rowMeans(a) ~ rep(1:5))
```

