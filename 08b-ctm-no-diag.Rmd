---
title: "Correlated topic model with diagonal covariance"
output: html_notebook
---

# Goal

  * Use the `stm` package to fit CTMs with diagonal $\Sigma$
  * Have a baseline for comparing structural topic models

# Libraries used

```{r, warning=F, message=F, error=F, comment=F}
library(tidyverse)
library(slam)
library(stm)
library(foreach)
library(doParallel)
```

Set up parallel runs

```{r}
registerDoParallel(5)
getDoParWorkers()
```

# Load the final data

See [06-dataset-comparison.Rmd](https://github.com/phively/uchicago-thesis/blob/master/06-dataset-comparison.Rmd) for details on how the sparse matrix was generated.

```{r, message=F}
# Load sparse matrix with no tex
load(file = "data/sparse_matrix_no_tex.zip")
sparse <- readCorpus(sparse, type = "slam")
```

# CTM method without correlations

Topics $K \in \left\{ 5, 10, \dots, 50 \right\}$

```{r}
# 5
gc()
nc_ctm05 <- searchK(sparse$documents, sparse$vocab, K = 5, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm05, file = "results/nc_ctm05.zip", compress = "xz", compression_level = 1)

# 10
gc()
nc_ctm10 <- searchK(sparse$documents, sparse$vocab, K = 10, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm10, file = "results/nc_ctm10.zip", compress = "xz", compression_level = 1)

# 15
gc()
nc_ctm15 <- searchK(sparse$documents, sparse$vocab, K = 15, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm15, file = "results/nc_ctm15.zip", compress = "xz", compression_level = 1)

# 20
gc()
nc_ctm20 <- searchK(sparse$documents, sparse$vocab, K = 20, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm20, file = "results/nc_ctm20.zip", compress = "xz", compression_level = 1)

# 25
gc()
nc_ctm25 <- searchK(sparse$documents, sparse$vocab, K = 25, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm25, file = "results/nc_ctm25.zip", compress = "xz", compression_level = 1)

# 30
gc()
nc_ctm30 <- searchK(sparse$documents, sparse$vocab, K = 30, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm30, file = "results/nc_ctm30.zip", compress = "xz", compression_level = 1)

# 35
gc()
nc_ctm35 <- searchK(sparse$documents, sparse$vocab, K = 35, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm35, file = "results/nc_ctm35.zip", compress = "xz", compression_level = 1)

# 40
gc()
nc_ctm40 <- searchK(sparse$documents, sparse$vocab, K = 40, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm40, file = "results/nc_ctm40.zip", compress = "xz", compression_level = 1)

# 45
gc()
nc_ctm45 <- searchK(sparse$documents, sparse$vocab, K = 45, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm45, file = "results/nc_ctm45.zip", compress = "xz", compression_level = 1)

# 50
gc()
nc_ctm50 <- searchK(sparse$documents, sparse$vocab, K = 50, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm50, file = "results/nc_ctm50.zip", compress = "xz", compression_level = 1)
```

```{r}
xval <- bind_rows(nc_ctm05$results, nc_ctm10$results, nc_ctm15$results, nc_ctm20$results, nc_ctm25$results,
  nc_ctm30$results, nc_ctm35$results, nc_ctm40$results, nc_ctm45$results, nc_ctm50$results)
write.csv(xval, file = "results/nc_ctm_xval.csv", row.names = FALSE)
```

```{r}
xval %>% ggplot(aes(x = K, y = heldout)) + geom_point()
```

There's clearly room for improvement.

# CTM method, diagonal $\Sigma$, 60 through 150

```{r}
# 60
gc()
nc_ctm60 <- searchK(sparse$documents, sparse$vocab, K = 60, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm60, file = "results/nc_ctm60.zip", compress = "xz", compression_level = 1)

# 70
gc()
nc_ctm70 <- searchK(sparse$documents, sparse$vocab, K = 70, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm70, file = "results/nc_ctm70.zip", compress = "xz", compression_level = 1)

# 80
gc()
nc_ctm80 <- searchK(sparse$documents, sparse$vocab, K = 80, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm80, file = "results/nc_ctm80.zip", compress = "xz", compression_level = 1)

# 90
gc()
nc_ctm90 <- searchK(sparse$documents, sparse$vocab, K = 90, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm90, file = "results/nc_ctm90.zip", compress = "xz", compression_level = 1)

# 100
gc()
nc_ctm100 <- searchK(sparse$documents, sparse$vocab, K = 100, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm100, file = "results/nc_ctm100.zip", compress = "xz", compression_level = 1)

# 110
gc()
nc_ctm110 <- searchK(sparse$documents, sparse$vocab, K = 110, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm110, file = "results/nc_ctm110.zip", compress = "xz", compression_level = 1)

# 120
gc()
nc_ctm120 <- searchK(sparse$documents, sparse$vocab, K = 120, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm120, file = "results/nc_ctm120.zip", compress = "xz", compression_level = 1)

# 130
gc()
nc_ctm130 <- searchK(sparse$documents, sparse$vocab, K = 130, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm130, file = "results/nc_ctm130.zip", compress = "xz", compression_level = 1)

# 140
gc()
nc_ctm140 <- searchK(sparse$documents, sparse$vocab, K = 140, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm140, file = "results/nc_ctm140.zip", compress = "xz", compression_level = 1)

# 150
gc()
nc_ctm150 <- searchK(sparse$documents, sparse$vocab, K = 150, init.type = "Spectral", ngroups = 7,
  control = list(maxV = length(sparse$vocab)), proportion = .5, heldout.seed = 13316, sigma.prior = 1)
save(nc_ctm150, file = "results/nc_ctm150.zip", compress = "xz", compression_level = 1)
```